#!/usr/bin/env bash
iDIR="$HOME/.local/share/icons/brightness"

# =====================
# Helpers
# =====================
get_backlight_device() {
    # Try to find the backlight device
    if [[ -d /sys/class/backlight/intel_backlight ]]; then
        echo "intel_backlight"
    elif [[ -d /sys/class/backlight/amdgpu_bl0 ]]; then
        echo "amdgpu_bl0"
    elif [[ -d /sys/class/backlight/acpi_video0 ]]; then
        echo "acpi_video0"
    else
        # Fallback to first available device
        ls /sys/class/backlight/ | head -n1
    fi
}

BACKLIGHT_DEVICE=$(get_backlight_device)
BACKLIGHT_PATH="/sys/class/backlight/$BACKLIGHT_DEVICE"

# =====================
# Brightness
# =====================
get_brightness() {
    if [[ ! -d "$BACKLIGHT_PATH" ]]; then
        echo "0"
        return
    fi

    current=$(cat "$BACKLIGHT_PATH/brightness")
    max=$(cat "$BACKLIGHT_PATH/max_brightness")

    # Calculate percentage
    echo $((current * 100 / max))
}

get_icon() {
    brightness=$(get_brightness)

    if (( brightness == 0 )); then
        echo "$iDIR/brightness-off.png"
    elif (( brightness <= 25 )); then
        echo "$iDIR/brightness-low.png"
    elif (( brightness <= 50 )); then
        echo "$iDIR/brightness-mid.png"
    elif (( brightness <= 75 )); then
        echo "$iDIR/brightness-high.png"
    else
        echo "$iDIR/brightness-max.png"
    fi
}

notify_user() {
    brightness=$(get_brightness)
    icon=$(get_icon)

    notify-send -a brightness -e -u low -i "$icon" \
        -h int:value:"$brightness" \
        -h string:x-canonical-private-synchronous:brightness_notif \
        "Brightness: ${brightness}%"
}

set_brightness() {
    if [[ ! -d "$BACKLIGHT_PATH" ]]; then
        notify-send -a brightness -u critical "Error" "Backlight device not found"
        return 1
    fi

    local percent=$1

    # Clamp between 5 and 100
    if (( percent < 5 )); then
        percent=5
    elif (( percent > 100 )); then
        percent=100
    fi

    max=$(cat "$BACKLIGHT_PATH/max_brightness")
    new_brightness=$((max * percent / 100))

    # Use brightnessctl if available (handles permissions better)
    if command -v brightnessctl &> /dev/null; then
        brightnessctl -d "$BACKLIGHT_DEVICE" set "${percent}%" > /dev/null 2>&1
    else
        # Fallback to direct write (requires proper udev rules or sudo)
        echo "$new_brightness" | tee "$BACKLIGHT_PATH/brightness" > /dev/null 2>&1
    fi

    notify_user
}

inc_brightness() {
    current=$(get_brightness)
    new_brightness=$((current + 5))
    set_brightness "$new_brightness"
}

dec_brightness() {
    current=$(get_brightness)
    new_brightness=$((current - 5))
    set_brightness "$new_brightness"
}

# =====================
# Dispatcher
# =====================
show_help() {
    cat << EOF
Usage: $(basename "$0") [OPTION]

Brightness Control:
  --get       Get current brightness percentage
  --inc       Increase brightness by 5%
  --dec       Decrease brightness by 5%
  --set VALUE Set brightness to specific percentage (5-100)
  --get-icon  Get brightness icon path
  --help      Show this help message

Note: This script requires either:
  - brightnessctl installed, or
  - Proper udev rules for /sys/class/backlight access
EOF
}

case "$1" in
    --get) get_brightness ;;
    --inc) inc_brightness ;;
    --dec) dec_brightness ;;
    --set) set_brightness "$2" ;;
    --get-icon) get_icon ;;
    --help) show_help ;;
    *) get_brightness ;;
esac
