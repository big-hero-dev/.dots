#!/usr/bin/env bash
iDIR="$HOME/.local/share/icons/audio/"

# =====================
# Helpers
# =====================

get_sink() {
    pactl get-default-sink
}

get_source() {
    pactl get-default-source
}

# =====================
# Volume (Speaker)
# =====================

get_volume() {
    if pactl get-sink-mute "$(get_sink)" | grep -q yes; then
        echo "Muted"
    else
        pactl get-sink-volume "$(get_sink)" \
            | grep -o '[0-9]\+%' | head -n1
    fi
}

get_icon() {
    vol=$(get_volume)
    if [[ "$vol" == "Muted" ]]; then
        echo "$iDIR/volume-mute.png"
    else
        v=${vol%\%}
        if (( v <= 30 )); then
            echo "$iDIR/volume-low.png"
        elif (( v <= 60 )); then
            echo "$iDIR/volume-mid.png"
        else
            echo "$iDIR/volume-high.png"
        fi
    fi
}

notify_user() {
    vol=$(get_volume)
    icon=$(get_icon)

    if [[ "$vol" == "Muted" ]]; then
        notify-send -a volume -e -u low -i "$icon" \
            -h string:x-canonical-private-synchronous:volume_notif \
            "Volume: Muted"
    else
        notify-send -a volume -e -u low -i "$icon" \
            -h int:value:"${vol%\%}" \
            -h string:x-canonical-private-synchronous:volume_notif \
            "Volume: $vol"
    fi
}

inc_volume() {
    pactl set-sink-mute "$(get_sink)" 0
    pactl set-sink-volume "$(get_sink)" +5%
    notify_user
}

dec_volume() {
    pactl set-sink-mute "$(get_sink)" 0
    pactl set-sink-volume "$(get_sink)" -5%
    notify_user
}

toggle_mute() {
    pactl set-sink-mute "$(get_sink)" toggle
    notify_user
}

# =====================
# Microphone
# =====================

get_mic_volume() {
    if pactl get-source-mute "$(get_source)" | grep -q yes; then
        echo "Muted"
    else
        pactl get-source-volume "$(get_source)" \
            | grep -o '[0-9]\+%' | head -n1
    fi
}

get_mic_icon() {
    if [[ "$(get_mic_volume)" == "Muted" ]]; then
        echo "$iDIR/microphone-mute.png"
    else
        echo "$iDIR/microphone.png"
    fi
}

notify_mic_user() {
    vol=$(get_mic_volume)
    icon=$(get_mic_icon)

    if [[ "$vol" == "Muted" ]]; then
        notify-send -a mic -e -u low -i "$icon" \
            -h string:x-canonical-private-synchronous:mic_notif \
            "Mic: Muted"
    else
        notify-send -a mic  -e -u low -i "$icon" \
            -h int:value:"${vol%\%}" \
            -h string:x-canonical-private-synchronous:mic_notif \
            "Mic: $vol"
    fi
}

inc_mic_volume() {
    pactl set-source-mute "$(get_source)" 0
    pactl set-source-volume "$(get_source)" +5%
    notify_mic_user
}

dec_mic_volume() {
    pactl set-source-mute "$(get_source)" 0
    pactl set-source-volume "$(get_source)" -5%
    notify_mic_user
}

toggle_mic() {
    pactl set-source-mute "$(get_source)" toggle
    notify_mic_user
}

# =====================
# Dispatcher
# =====================

case "$1" in
    --get) get_volume ;;
    --inc) inc_volume ;;
    --dec) dec_volume ;;
    --toggle) toggle_mute ;;
    --toggle-mic) toggle_mic ;;
    --get-icon) get_icon ;;
    --get-mic-icon) get_mic_icon ;;
    --mic-inc) inc_mic_volume ;;
    --mic-dec) dec_mic_volume ;;
    *) get_volume ;;
esac
