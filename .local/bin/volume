#!/usr/bin/env bash

# =====================
# Helpers
# =====================
get_sink() {
    pactl get-default-sink
}

get_source() {
    pactl get-default-source
}

# =====================
# Volume (Speaker)
# =====================
get_volume() {
    if pactl get-sink-mute "$(get_sink)" | grep -q yes; then
        echo "Muted"
    else
        pactl get-sink-volume "$(get_sink)" \
            | grep -o '[0-9]\+%' | head -n1
    fi
}

get_icon() {
    vol=$(get_volume)

    if [[ "$vol" == "Muted" ]]; then
        echo "󰖁"   # muted
    else
        v=${vol%\%}
        if (( v <= 30 )); then
            echo "󰕿"
        elif (( v <= 60 )); then
            echo "󰖀"
        else
            echo "󰕾"
        fi
    fi
}

notify_user() {
    vol=$(get_volume)
    icon=$(get_icon)

    if [[ "$vol" == "Muted" ]]; then
        notify-send -a volume -u low -e \
            -h string:x-canonical-private-synchronous:volume \
            "$icon  Volume: Muted"
    else
        notify-send -a volume -u low -e \
            -h int:value:"${vol%\%}" \
            -h string:x-canonical-private-synchronous:volume \
            "$icon  Volume: $vol"
    fi
}

inc_volume() {
    pactl set-sink-mute "$(get_sink)" 0

    current=$(pactl get-sink-volume "$(get_sink)" \
        | grep -o '[0-9]\+%' | head -n1 | tr -d '%')

    if (( current < 100 )); then
        pactl set-sink-volume "$(get_sink)" +5%

        new=$(pactl get-sink-volume "$(get_sink)" \
            | grep -o '[0-9]\+%' | head -n1 | tr -d '%')

        if (( new > 100 )); then
            pactl set-sink-volume "$(get_sink)" 100%
        fi
    fi

    notify_user
}

dec_volume() {
    pactl set-sink-mute "$(get_sink)" 0
    pactl set-sink-volume "$(get_sink)" -5%
    notify_user
}

toggle_mute() {
    pactl set-sink-mute "$(get_sink)" toggle
    notify_user
}

# =====================
# Microphone
# =====================
get_mic_volume() {
    if pactl get-source-mute "$(get_source)" | grep -q yes; then
        echo "Muted"
    else
        pactl get-source-volume "$(get_source)" \
            | grep -o '[0-9]\+%' | head -n1
    fi
}

get_mic_icon() {
    if [[ "$(get_mic_volume)" == "Muted" ]]; then
        echo "󰍭"
    else
        echo "󰍬"
    fi
}

notify_mic_user() {
    vol=$(get_mic_volume)
    icon=$(get_mic_icon)

    if [[ "$vol" == "Muted" ]]; then
        notify-send -a mic -u low -e \
            -h string:x-canonical-private-synchronous:mic \
            "$icon  Mic: Muted"
    else
        notify-send -a mic -u low -e \
            -h int:value:"${vol%\%}" \
            -h string:x-canonical-private-synchronous:mic \
            "$icon  Mic: $vol"
    fi
}

inc_mic_volume() {
    pactl set-source-mute "$(get_source)" 0

    current=$(pactl get-source-volume "$(get_source)" \
        | grep -o '[0-9]\+%' | head -n1 | tr -d '%')

    if (( current < 100 )); then
        pactl set-source-volume "$(get_source)" +5%
    fi

    notify_mic_user
}

dec_mic_volume() {
    pactl set-source-mute "$(get_source)" 0
    pactl set-source-volume "$(get_source)" -5%
    notify_mic_user
}

toggle_mic() {
    pactl set-source-mute "$(get_source)" toggle
    notify_mic_user
}

# =====================
# Dispatcher
# =====================
case "$1" in
    --get) get_volume ;;
    --inc) inc_volume ;;
    --dec) dec_volume ;;
    --toggle) toggle_mute ;;
    --toggle-mic) toggle_mic ;;
    --mic-inc) inc_mic_volume ;;
    --mic-dec) dec_mic_volume ;;
    *) get_volume ;;
esac

